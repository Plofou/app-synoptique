<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Synoptique Technicien</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --border: #C6C6C8;
            --success: #34C759;
            --warning: #FF9500;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            height: 100vh;
            width: 100%;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* --- S√âCURIT√â --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1d1d1f; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10000; color: white; transition: opacity 0.3s;
        }
        .auth-box { background: #2c2c2e; padding: 25px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #1c1c1e; color: white; font-size: 1.2rem; text-align: center; box-sizing: border-box; }

        /* --- HEADER --- */
        .header {
            background-color: var(--card);
            padding: 12px 20px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 50; flex-shrink: 0;
            transition: background-color 0.3s;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle { display: flex; align-items: center; gap: 8px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        .dark-mode-label { font-size: 18px; }

        /* Save Status */
        .save-status {
            display: flex; align-items: center; gap: 6px; padding: 6px 12px;
            background: #f0f0f0; border-radius: 20px; font-size: 13px; font-weight: 500; min-width: 110px;
            transition: all 0.3s;
        }
        .save-status.saved { background: #e8f5e9; color: #2e7d32; }
        .save-status.unsaved { background: #fff3e0; color: #f57c00; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .status-dot { font-size: 12px; }

        /* Header Actions */
        .header-actions { display: flex; gap: 8px; flex: 0 0 auto; }

        .header-btn-labeled {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 2px; padding: 8px 12px; border: none; border-radius: 8px;
            background: white; cursor: pointer; transition: all 0.2s; min-width: 70px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header-btn-labeled:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        .header-btn-labeled:active { transform: translateY(0); }
        .header-btn-labeled.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        
        .btn-icon { font-size: 20px; }
        .btn-label { font-size: 11px; font-weight: 600; color: #333; }

        .save-btn { border: 2px solid var(--success); }
        .save-btn:hover { background: #f0fdf4; }
        .open-btn { border: 2px solid var(--primary); }
        .open-btn:hover { background: #eff6ff; }
        .export-btn { border: 2px solid var(--warning); }
        .export-btn:hover { background: #fff7ed; }
        .add-btn { border: 2px solid var(--primary); }
        .add-btn:hover { background: #eff6ff; }
        
        /* AJOUT√â : Style bouton suppression de zone */
        .del-zone-btn { border: 2px solid var(--danger); color: var(--danger); }
        .del-zone-btn:hover { background: #fff1f2; }
        .del-zone-btn.active { background: var(--danger); color: white; }
        .del-zone-btn.active .btn-label { color: white; }

        .company-logo {
            height: 50px; 
            width: auto;
            margin-left: 20px;
            margin-right: auto; 
            object-fit: contain;
            transition: transform 0.2s;
        }
        .company-logo:hover { transform: scale(1.05); }

        .site-name-input {
            flex: 0 0 auto; width: 250px; padding: 10px 15px;
            border: 2px solid var(--primary); border-radius: 8px;
            font-size: 15px; background: white; margin-left: 0;
        }

        /* --- DARK MODE STYLES --- */
        body.dark-mode { background-color: #1a1a1a; color: #e0e0e0; height: 100vh; }
        body.dark-mode .header { background-color: #2c2c2c; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        body.dark-mode .site-name-input { background: #3a3a3a; color: white; border-color: #555; }
        body.dark-mode #workspace-container { background-color: #1a1a1a; background-image: radial-gradient(#444 1px, transparent 1px); }
        body.dark-mode .node { background: #2c2c2c; border-color: #555; color: #e0e0e0; }
        body.dark-mode .node .device-name { color: #e0e0e0; }
        body.dark-mode .modal-content { background: #2c2c2c; color: #e0e0e0; }
        body.dark-mode .form-group input, body.dark-mode .form-group select { background: #3a3a3a; color: white; border-color: #555; }
        body.dark-mode .header-btn-labeled { background: #3a3a3a; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        body.dark-mode .btn-label { color: #e0e0e0; }
        body.dark-mode .save-btn:hover { background: #1b3320; }
        body.dark-mode .open-btn:hover, body.dark-mode .add-btn:hover { background: #1a273b; }
        body.dark-mode .export-btn:hover { background: #3b2a1a; }
        body.dark-mode .del-zone-btn:hover { background: #3b1a1a; } /* Hover rouge sombre */
        body.dark-mode .save-status { background: #333; color: #aaa; }
        body.dark-mode .save-status.saved { background: #1b3320; color: #4caf50; }
        body.dark-mode .save-status.unsaved { background: #3b2a1a; color: #ff9800; }
        body.dark-mode .company-logo { filter: brightness(0.9); }
        body.dark-mode .zoom-indicator { background: rgba(44, 44, 44, 0.95); color: #e0e0e0; }
        body.dark-mode .position-indicator { background: rgba(50, 50, 50, 0.9); color: #e0e0e0; }

        /* HP simplifi√© - CSS */
        #hpGroup {
            background: #F0F9FF;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #3B82F6;
        }
        .hp-name-field {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .hp-name-field label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1E40AF;
            min-width: 50px;
        }
        .hp-name-field input {
            flex: 1;
            padding: 10px;
            border: 2px solid #93C5FD;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            font-weight: bold;
            box-sizing: border-box;
        }
        .hp-name-field input:focus {
            outline: none;
            border-color: #3B82F6;
            background: #F0F9FF;
        }
        body.dark-mode #hpGroup {
            background: #1e3a5f;
            border-color: #3b82f6;
        }
        body.dark-mode .hp-name-field label {
            color: #60a5fa;
        }
        body.dark-mode .hp-name-field input {
            background: #3a3a3a;
            color: white;
            border-color: #3b82f6;
        }

        /* --- WORKSPACE & ZOOM --- */
        #workspace-wrapper { 
            flex: 1; 
            position: relative; 
            overflow: auto; 
            -webkit-overflow-scrolling: touch; 
            z-index: 1; 
            background-color: var(--bg);
            transition: background-color 0.3s;
        }
        
        #workspace-container { 
            position: relative; 
            width: 10000px; 
            height: 10000px; 
            background-image: radial-gradient(#ccc 1px, transparent 1px); 
            background-size: 30px 30px; 
            touch-action: none; 
            transform-origin: 0 0; 
            transition: transform 0.1s ease-out; 
        }
        
        #connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }

        /* --- BOITIER EQUIPEMENT --- */
        .node {
            position: absolute; background: var(--card); border: 2px solid #ddd; border-radius: 10px;
            padding: 10px; width: 160px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 2; user-select: none; 
            touch-action: none; 
            height: auto; 
            min-height: 120px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .node.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.2); z-index: 10; }
        .node .icon { margin-bottom: 5px; height: 60px; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .node-image { max-width: 90%; max-height: 100%; object-fit: contain; }
        .node .device-name { font-weight: 700; font-size: 0.9rem; text-align: center; margin-top: 5px; color: #1d1d1f; }
        .node .ip-addr { font-size: 0.8rem; color: var(--primary); font-family: monospace; font-weight: 600; margin: 2px 0; }
        .node .loc { font-size: 0.75rem; color: #86868b; text-align: center; font-style: italic; }

        .quick-add-btn {
            position: absolute; top: -12px; right: -12px;
            width: 28px; height: 28px;
            background: #007AFF; color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 101; transition: transform 0.1s;
        }
        .quick-add-btn:hover { transform: scale(1.1); }
        .quick-add-btn:active { transform: scale(0.95); }

        .quick-delete-btn {
            position: absolute; top: -12px; left: -12px;
            width: 28px; height: 28px;
            background: #FF3B30; color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 101; transition: transform 0.1s;
        }
        .quick-delete-btn:hover { transform: scale(1.1); background: #E62E25; }
        .quick-delete-btn:active { transform: scale(0.95); }

        .node.selected .quick-add-btn { display: flex; }
        .node.selected .quick-delete-btn { display: flex; }

        .photo-section {
            position: relative; width: 100%; height: 100px; margin-bottom: 8px;
            border-radius: 8px 8px 4px 4px; overflow: hidden; background-color: #eee; cursor: pointer;
        }

        .field-photo { width: 100%; height: 100%; object-fit: cover; }

        .photo-badge {
            position: absolute; top: 5px; right: 5px;
            background: rgba(0, 0, 0, 0.6); color: white;
            padding: 3px 6px; border-radius: 4px; font-size: 14px; pointer-events: none;
        }

        .position-indicator {
            position: fixed; 
            bottom: 100px; 
            left: 10px;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 8px 12px; border-radius: 6px;
            font-family: monospace; font-size: 12px;
            z-index: 300; pointer-events: none;
        }
        
        /* --- UI FLOTTANTE --- */
        .floating-ui { position: fixed; bottom: 30px; display: flex; align-items: center; z-index: 250; }
        .floating-ui.modal-open { display: none !important; }
        .trash-zone { left: 20px; flex-direction: column-reverse; gap: 15px; }
        .zoom-zone { right: 20px; gap: 10px; flex-direction: column; }

        .fab-btn {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .fab-btn:active { transform: scale(0.95); }

        #photo-btn { background: var(--primary); color: white; display: none; margin-bottom: 5px;}
        #photo-btn.show { display: flex; animation: popIn 0.2s; }

        .zoom-btn { background: white; color: #333; font-weight: bold; font-size: 28px; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- MODALE AJOUT --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 200; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: 40px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* MODAL VISUALISATION PHOTO */
        #photo-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center;
            z-index: 300; flex-direction: column;
        }
        #full-photo { max-width: 95%; max-height: 80vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .photo-controls { margin-top: 20px; display: flex; gap: 20px; }
        .icon-btn { background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);}

        .zoom-indicator {
            position: fixed;
            bottom: 240px; 
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 250;
            min-width: 50px;
            text-align: center;
        }

        /* AJOUT√â : Zone de suppression (carr√© volant) */
        #selectionBox {
            position: absolute;
            background-color: rgba(255, 59, 48, 0.2);
            border: 2px dashed #FF3B30;
            display: none;
            pointer-events: none; /* Laisse passer les clics pour le 2√®me clic */
            z-index: 1000;
        }
        /* Curseur sp√©cial pour le mode s√©lection */
        body.selection-mode #workspace-container {
            cursor: crosshair !important;
        }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h3>üîê Acc√®s Technicien</h3>
            <input type="tel" id="pass-field" class="auth-input" placeholder="Code" maxlength="4">
            <button class="btn-full btn-primary" onclick="checkPass()">Valider</button>
        </div>
    </div>

    <input type="file" id="fileLoader" style="display:none" accept=".json" onchange="loadProject(this)">
    <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="processPhoto(this)">

    <div class="header">
        <div class="dark-mode-toggle">
            <label class="switch">
                <input type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()">
                <span class="slider"></span>
            </label>
            <span class="dark-mode-label">üåô</span>
        </div>

        <div class="save-status saved" id="saveStatus">
            <span class="status-dot">üü¢</span>
            <span class="status-text">Sauvegard√©</span>
        </div>

        <div class="header-actions">
            <button class="header-btn-labeled save-btn" onclick="saveProject()" title="Sauvegarder">
                <span class="btn-icon">üíæ</span>
                <span class="btn-label">Sauver</span>
            </button>
            
            <button class="header-btn-labeled open-btn" onclick="triggerLoad()" title="Ouvrir">
                <span class="btn-icon">üìÇ</span>
                <span class="btn-label">Ouvrir</span>
            </button>
            
            <button class="header-btn-labeled export-btn disabled" id="btnDownload" onclick="downloadPDF()" title="Exporter en PDF">
                <span class="btn-icon">‚¨á</span>
                <span class="btn-label">Export PDF</span>
            </button>
            
            <button class="header-btn-labeled add-btn" onclick="openAddModal()" title="Ajouter √©quipement">
                <span class="btn-icon">+</span>
                <span class="btn-label">Ajouter</span>
            </button>

            <button class="header-btn-labeled del-zone-btn" id="delZoneBtn" onclick="toggleSelectionMode()" title="Supprimer une zone">
                <span class="btn-icon">‚õù</span>
                <span class="btn-label">Zone Suppr.</span>
            </button>
        </div>

        <img src="myco.png" alt="MyConnect" class="company-logo">

        <input type="text" id="siteName" class="site-name-input" placeholder="Nom du site *" oninput="checkInput()">
    </div>

    <div class="floating-ui trash-zone">
        <button class="fab-btn" id="photo-btn" onclick="triggerPhotoUpload()">üì∑</button>
    </div>

    <div class="floating-ui zoom-zone">
        <button class="fab-btn zoom-btn" onclick="updateZoom(0.1)">+</button>
        <button class="fab-btn zoom-btn" style="font-size:20px;" onclick="resetZoom()">‚åÇ</button>
        <button class="fab-btn zoom-btn" onclick="updateZoom(-0.1)">-</button>
    </div>

    <div class="zoom-indicator" id="zoomIndicator">100%</div>

    <div class="position-indicator" id="positionIndicator">X: 0 | Y: 0</div>

    <div id="workspace-wrapper">
        <div id="workspace-container" onclick="handleWorkspaceClick(event)">
            <svg id="connections-layer"></svg>
            <div id="selectionBox"></div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <h3 id="modalTitle">Nouvel √âquipement</h3>
            <div class="form-group">
                <label>Type d'appareil</label>
                <select id="newType" onchange="updateFormFields(this.value)">
                    <option value="routeur">Routeur Mikrotik</option>
                    <option value="switch">Switch Hikvision</option>
                    <option value="nvr">NVR Hikvision</option>
                    <option value="bullet">Cam√©ra Bullet</option>
                    <option value="dome">Cam√©ra D√¥me</option>
                    <option value="box">Box / Internet</option>
                    <option value="ecran">√âcran (PC)</option>
                    <option value="radio">Antenne Radio</option>
                    <option value="ampli">Ampli Audio</option>
                    <option value="pupitre">Pupitre Micro</option>
                </select>
            </div>

            <div class="form-group" id="radioModeGroup" style="display:none;">
                <label>Mode</label>
                <select id="radioMode">
                    <option value="couple">Couple PE/PR (automatique)</option>
                    <option value="pe">Point √âmetteur (PE) seul</option>
                    <option value="pr">Point R√©cepteur (PR) seul</option>
                </select>
            </div>

            <div class="form-group" id="quantityGroup" style="display:none;">
                <label>Quantit√© √† ajouter</label>
                <select id="newQuantity">
                    <option value="1">1 (Standard)</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>

            <div class="form-group" id="hpGroup" style="display:none;">
                <label>üîä Haut-Parleurs (HP) connect√©s</label>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85rem; color: #666;">Nombre de HP (1 √† 4)</label>
                    <select id="hpCount" onchange="updateHPFields()" 
                            style="width: 100%; padding: 10px; border: 2px solid #007AFF; border-radius: 8px; font-size: 1rem; background: #EFF6FF; font-weight: bold;">
                        <option value="1">1 HP</option>
                        <option value="2">2 HP</option>
                        <option value="3">3 HP</option>
                        <option value="4">4 HP</option>
                    </select>
                </div>
                
                <div style="background: #FFF7ED; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #F59E0B;">
                    <small style="color: #92400E; font-size: 0.85rem;">
                        ‚ÑπÔ∏è Les HP h√©ritent de la localisation de l'ampli (connexion analogique)
                    </small>
                </div>
                
                <div id="hpNamesContainer"></div>
            </div>
            
            <div class="form-group">
                <label>Nom / R√©f</label>
                <div id="nameFieldContainer">
                    <input type="text" id="newDeviceName" placeholder="Ex: Switch-RDC">
                </div>
            </div>
            
            <div class="form-group">
                <label>Adresse IP</label>
                <div id="ipFieldContainer">
                    <input type="text" id="newIP" placeholder="Ex: 192.168.1.10">
                </div>
            </div>

            <div class="form-group" id="locationGroup">
                <label id="locationLabel">Localisation</label>
                <input type="text" id="newLocation" placeholder="Ex: Baie de brassage">
            </div>

            <div class="form-group" id="locationPRGroup" style="display:none;">
                <label>Localisation PR</label>
                <input type="text" id="newLocationPR" placeholder="Ex: Toit b√¢timent B">
            </div>

            <div class="form-group"><label>Connect√© √†</label><select id="newParent"><option value="">-- Racine --</option></select></div>
            <button id="modalActionBtn" class="btn-full btn-primary" onclick="addEquipment()">Ajouter</button>
            <button class="btn-full btn-cancel" onclick="closeAddModal()">Annuler</button>
        </div>
    </div>

    <div id="photo-modal-overlay">
        <img id="full-photo" src="" alt="Photo √©quipement">
        <div class="photo-controls">
            <button class="icon-btn" onclick="closePhotoViewer()" style="background:rgba(255,255,255,0.3)">‚úï</button>
            <button class="icon-btn" onclick="deleteCurrentPhoto()" style="background:rgba(255,59,48,0.6)">üóëÔ∏è</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let selectedEquipmentId = null;
        let currentZoom = 1;
        let editingEquipmentId = null;
        let suggestedX = null;
        let suggestedY = null;
        let lastSaved = null;
        let hasUnsavedChanges = false;
        
        // AJOUT√â : Variables pour la zone de suppression
        let isSelectionMode = false;
        let selectionStart = null;

        const presetsByType = {
            bullet: {
                names: ['CAM1', 'CAM2', 'CAM3', 'CAM4', 'CAM5', 'CAM6', 'CAM7', 'CAM8', 'CAM9', 'CAM10', 'CAM11', 'CAM12', 'CAM13', 'CAM14', 'CAM15', 'CAM16', 'CAM17', 'CAM18', 'CAM19', 'CAM20'],
                ips: ['172.16.0.101', '172.16.0.102', '172.16.0.103', '172.16.0.104', '172.16.0.105', '172.16.0.106', '172.16.0.107', '172.16.0.108', '172.16.0.109', '172.16.0.110', '172.16.0.111', '172.16.0.112', '172.16.0.113', '172.16.0.114', '172.16.0.115', '172.16.0.116', '172.16.0.117', '172.16.0.118', '172.16.0.119', '172.16.0.120']
            },
            dome: {
                names: ['CAM1', 'CAM2', 'CAM3', 'CAM4', 'CAM5', 'CAM6', 'CAM7', 'CAM8', 'CAM9', 'CAM10', 'CAM11', 'CAM12', 'CAM13', 'CAM14', 'CAM15', 'CAM16', 'CAM17', 'CAM18', 'CAM19', 'CAM20'],
                ips: ['172.16.0.101', '172.16.0.102', '172.16.0.103', '172.16.0.104', '172.16.0.105', '172.16.0.106', '172.16.0.107', '172.16.0.108', '172.16.0.109', '172.16.0.110', '172.16.0.111', '172.16.0.112', '172.16.0.113', '172.16.0.114', '172.16.0.115', '172.16.0.116', '172.16.0.117', '172.16.0.118', '172.16.0.119', '172.16.0.120']
            },
            switch: {
                names: ['SWITCH1', 'SWITCH2', 'SWITCH3', 'SWITCH4', 'SWITCH5', 'SWITCH6', 'SWITCH7', 'SWITCH8', 'SWITCH9', 'SWITCH10'],
                ips: ['172.16.0.201', '172.16.0.202', '172.16.0.203', '172.16.0.204', '172.16.0.205', '172.16.0.206', '172.16.0.207', '172.16.0.208', '172.16.0.209', '172.16.0.210']
            },
            nvr: {
                names: ['NVR1', 'NVR2', 'NVR3'],
                ips: ['172.16.0.1', '172.16.0.2', '172.16.0.3']
            },
            ampli: {
                names: ['AMPLI1', 'AMPLI2', 'AMPLI3', 'AMPLI4', 'AMPLI5'],
                ips: ['172.16.0.51', '172.16.0.52', '172.16.0.53', '172.16.0.54', '172.16.0.55']
            },
            routeur: {
                names: ['ROUTEUR1', 'ROUTEUR2'],
                ips: ['172.16.0.254', '172.16.0.253']
            }
        };

        const radioData = {
            pe: { names: [], ips: [] },
            pr: { names: [], ips: [] },
            couples: []
        };

        for (let i = 1; i <= 19; i++) {
            const peName = `PE${i}`;
            const prName = `PR${i}`;
            let peIpSuffix = (i <= 9) ? (10 + i) : (20 + i); 
            let prIpSuffix = (i <= 9) ? (20 + i) : (30 + i);
            let peIp = `172.16.0.${peIpSuffix}`;
            let prIp = `172.16.0.${prIpSuffix}`;
            radioData.pe.names.push(peName);
            radioData.pe.ips.push(peIp);
            radioData.pr.names.push(prName);
            radioData.pr.ips.push(prIp);
            radioData.couples.push({
                label: `${peName} + ${prName}`,
                peName: peName,
                prName: prName,
                peIp: peIp,
                prIp: prIp
            });
        }

        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeSwitch').checked;
            
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-label').textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                document.querySelector('.dark-mode-label').textContent = 'üåô';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        window.addEventListener('load', function() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.getElementById('darkModeSwitch').checked = true;
                toggleDarkMode();
            }
            render(); 
            updateZoomDisplay(); 
            
            setTimeout(function() {
                const wrapper = document.getElementById('workspace-wrapper');
                wrapper.scrollLeft = 0;
                wrapper.scrollTop = 0;
            }, 100);
        });

        document.getElementById('workspace-wrapper').addEventListener('scroll', function() {
            const x = Math.round(this.scrollLeft);
            const y = Math.round(this.scrollTop);
            document.getElementById('positionIndicator').textContent = `X: ${x} | Y: ${y}`;
        });

        function updateSaveStatus(saved) {
            const statusEl = document.getElementById('saveStatus');
            
            if (saved) {
                statusEl.className = 'save-status saved';
                statusEl.innerHTML = '<span class="status-dot">üü¢</span><span class="status-text">Sauvegard√©</span>';
                hasUnsavedChanges = false;
                lastSaved = new Date();
            } else {
                statusEl.className = 'save-status unsaved';
                statusEl.innerHTML = '<span class="status-dot">üü°</span><span class="status-text">Non sauvegard√©</span>';
                hasUnsavedChanges = true;
            }
        }

        function markAsUnsaved() {
            updateSaveStatus(false);
        }

        function checkPass() {
            if(document.getElementById('pass-field').value === "1234") {
                document.getElementById('auth-overlay').style.display = 'none';
            } else { alert("Code incorrect"); }
        }

        let equipments = [
            { id: 'root', type: 'routeur', deviceName: 'Routeur Principal', ip: '192.168.1.1', loc: 'Entr√©e', x: 100, y: 100, parent: null }
        ];

        function getIcon(type) {
            const imageMap = {
                'routeur': 'routeur.jpg',
                'switch': 'com1.jpg',
                'nvr': 'nvr.jpg',
                'bullet': 'cam1.jpg',
                'dome': 'cam2.jpg',
                'box': 'internet.jpg',
                'ecran': 'pc.jpg',
                'radio': 'radio.jpg',
                'ampli': 'ampli.jpg',
                'hp': 'hp.jpg',
                'pupitre': 'pupitre.jpg'
            };
            return `<img src="${imageMap[type] || 'routeur.jpg'}" class="node-image">`;
        }

        /* AJOUT√â : Zone de suppression - Fonctions */
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            const btn = document.getElementById('delZoneBtn');
            const body = document.body;
            
            if (isSelectionMode) {
                btn.classList.add('active');
                body.classList.add('selection-mode');
                showToast("Mode suppression : Cliquez pour commencer la zone");
                deselectAll();
            } else {
                btn.classList.remove('active');
                body.classList.remove('selection-mode');
                resetSelectionBox();
            }
        }

        function handleWorkspaceClick(e) {
            // Ignorer si ce n'est pas le mode s√©lection ou si on clique sur un √©quipement
            if (!isSelectionMode || e.target.closest('.node')) return;

            const wrapper = document.getElementById('workspace-wrapper');
            const container = document.getElementById('workspace-container');
            const rect = container.getBoundingClientRect();
            
            // Coordonn√©es relatives au conteneur zoom√©
            const x = (e.clientX - rect.left) / currentZoom;
            const y = (e.clientY - rect.top) / currentZoom;

            if (!selectionStart) {
                // Premier clic : d√©marrer la zone
                selectionStart = { x, y };
                const box = document.getElementById('selectionBox');
                box.style.left = x + 'px';
                box.style.top = y + 'px';
                box.style.width = '0px';
                box.style.height = '0px';
                box.style.display = 'block';
                
                // Ajouter √©couteur de mouvement
                document.addEventListener('mousemove', handleSelectionMove);
            } else {
                // Deuxi√®me clic : terminer la zone et proposer la suppression
                document.removeEventListener('mousemove', handleSelectionMove);
                processBulkDelete(selectionStart, { x, y });
                resetSelectionBox();
                toggleSelectionMode(); // Quitter le mode
            }
        }

        function handleSelectionMove(e) {
            if (!selectionStart) return;

            const container = document.getElementById('workspace-container');
            const rect = container.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / currentZoom;
            const currentY = (e.clientY - rect.top) / currentZoom;

            const box = document.getElementById('selectionBox');
            
            const width = Math.abs(currentX - selectionStart.x);
            const height = Math.abs(currentY - selectionStart.y);
            const left = Math.min(currentX, selectionStart.x);
            const top = Math.min(currentY, selectionStart.y);

            box.style.width = width + 'px';
            box.style.height = height + 'px';
            box.style.left = left + 'px';
            box.style.top = top + 'px';
        }

        function resetSelectionBox() {
            selectionStart = null;
            const box = document.getElementById('selectionBox');
            box.style.display = 'none';
            document.removeEventListener('mousemove', handleSelectionMove);
        }

        function processBulkDelete(start, end) {
            const minX = Math.min(start.x, end.x);
            const maxX = Math.max(start.x, end.x);
            const minY = Math.min(start.y, end.y);
            const maxY = Math.max(start.y, end.y);

            // Trouver les √©quipements dans la zone
            // On consid√®re qu'un √©quipement est "dans" la zone si son centre y est
            const toDelete = equipments.filter(eq => {
                const centerX = eq.x + 80; // Largeur approx 160/2
                const centerY = eq.y + 60; // Hauteur approx 120/2
                return centerX >= minX && centerX <= maxX && centerY >= minY && centerY <= maxY;
            });

            if (toDelete.length === 0) {
                showToast("Aucun √©quipement s√©lectionn√©");
                return;
            }

            if (confirm(`Voulez-vous supprimer ces ${toDelete.length} √©quipements s√©lectionn√©s ?`)) {
                const idsToDelete = toDelete.map(eq => eq.id);
                
                // Filtrer la liste principale
                equipments = equipments.filter(eq => !idsToDelete.includes(eq.id));

                // Nettoyer les liens orphelins
                equipments.forEach(eq => {
                    if (idsToDelete.includes(eq.parent)) eq.parent = null;
                    if (idsToDelete.includes(eq.linkedTo)) delete eq.linkedTo;
                });

                markAsUnsaved();
                render();
                showToast(`üóëÔ∏è ${toDelete.length} √©quipements supprim√©s`);
            }
        }
        
        /* Annuler s√©lection avec Echap */
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isSelectionMode) {
                toggleSelectionMode();
            }
        });

        function saveProject() {
            const name = document.getElementById('siteName').value || "Synoptique_SansNom";
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(equipments));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", name + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            updateSaveStatus(true); 
            showToast("üíæ Projet sauvegard√© !");
        }

        function triggerLoad() { document.getElementById('fileLoader').click(); }

        function loadProject(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if(Array.isArray(loadedData)) {
                        equipments = loadedData;
                        render();
                        let fileName = file.name.replace('.json', '');
                        if(fileName.includes('Synoptique_')) fileName = fileName.replace('Synoptique_', '');
                        if(fileName !== 'SansNom') document.getElementById('siteName').value = fileName;
                        
                        updateSaveStatus(true); 
                        showToast("Projet charg√© avec succ√®s ! üìÇ");
                    } else { alert("Format de fichier invalide."); }
                } catch(err) { alert("Erreur lors de la lecture du fichier."); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function updateFormFields(type, currentName = '', currentIP = '') {
            const radioModeGroup = document.getElementById('radioModeGroup');
            const quantityGroup = document.getElementById('quantityGroup');
            const hpGroup = document.getElementById('hpGroup');
            
            document.getElementById('locationLabel').innerText = "Localisation";
            document.getElementById('locationPRGroup').style.display = 'none';

            // Reset par d√©faut
            radioModeGroup.style.display = 'none';
            quantityGroup.style.display = 'none';
            hpGroup.style.display = 'none';

            if (type === 'radio') {
                radioModeGroup.style.display = 'block';
                updateRadioFields(currentName, currentIP);
                return;
            } 
            else if (type === 'ampli') {
                hpGroup.style.display = 'block'; // Affiche le groupe HP pour les amplis
                updateHPFields(); // Initialise les champs
            }
            
            // NOUVEAU : Afficher quantit√© uniquement si mode AJOUT (pas √©dition) et type compatible
            if (!editingEquipmentId && presetsByType[type]) {
                quantityGroup.style.display = 'block';
            }

            const presets = presetsByType[type];
            if (presets) {
                const nameIndex = presets.names.indexOf(currentName);
                const isManual = (currentName && nameIndex === -1);
                if (isManual) renderInputs(currentName, currentIP);
                else renderSelects(type, currentName, currentIP);
            } else {
                renderInputs(currentName, currentIP);
            }
        }

        function updateRadioFields(currentName = '', currentIP = '') {
            const mode = document.getElementById('radioMode').value;
            const nameContainer = document.getElementById('nameFieldContainer');
            const ipContainer = document.getElementById('ipFieldContainer');

            if (mode === 'couple') {
                document.getElementById('locationLabel').innerText = "Localisation PE";
                document.getElementById('locationPRGroup').style.display = 'block';
                document.getElementById('newLocation').placeholder = "Ex: Baie de brassage";

                let html = `<select id="newDeviceName">`;
                html += `<option value="">-- Choisir Couple --</option>`;
                radioData.couples.forEach((couple, index) => {
                    html += `<option value="${index}" data-type="couple">${couple.label}</option>`;
                });
                html += `<option value="__manual__">Saisie manuelle</option></select>`;
                nameContainer.innerHTML = html;
                ipContainer.innerHTML = `<input type="text" id="newIP" value="Automatique (2 IPs)" disabled style="background:#eee; color:#666;">`;
            } 
            else if (mode === 'pe') {
                document.getElementById('locationLabel').innerText = "Localisation";
                document.getElementById('locationPRGroup').style.display = 'none';
                renderRadioSelects(radioData.pe, currentName, currentIP);
            } 
            else if (mode === 'pr') {
                document.getElementById('locationLabel').innerText = "Localisation";
                document.getElementById('locationPRGroup').style.display = 'none';
                renderRadioSelects(radioData.pr, currentName, currentIP);
            }
        }
        
        /* MODIFI√â : G√©n√®re les champs de NOM UNIQUEMENT pour les HP */
        function updateHPFields() {
            const hpCount = parseInt(document.getElementById('hpCount')?.value || 1);
            const container = document.getElementById('hpNamesContainer');
            
            if (!container) return;
            
            // G√©n√©rer les champs de nom uniquement
            let html = '';
            for (let i = 1; i <= hpCount; i++) {
                html += `
                    <div class="hp-name-field">
                        <label>HP${i} :</label>
                        <input type="text" 
                               id="hpName${i}" 
                               placeholder="Ex: HP${i}, HP Entr√©e, HP Sc√®ne..." 
                               value="HP${i}">
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        document.getElementById('radioMode').addEventListener('change', function() {
            updateRadioFields();
        });

        function renderRadioSelects(data, nameVal, ipVal) {
            let nameHtml = `<select id="newDeviceName" onchange="syncRadioIP(this)">`;
            nameHtml += `<option value="">-- Choisir --</option>`;
            data.names.forEach((name, index) => {
                const selected = name === nameVal ? 'selected' : '';
                nameHtml += `<option value="${name}" data-ip="${data.ips[index]}" ${selected}>${name}</option>`;
            });
            nameHtml += `<option value="__manual__">Saisie manuelle...</option></select>`;
            document.getElementById('nameFieldContainer').innerHTML = nameHtml;

            let ipHtml = `<select id="newIP">`;
            ipHtml += `<option value="">-- Auto --</option>`;
            data.ips.forEach((ip) => {
                const selected = ip === ipVal ? 'selected' : '';
                ipHtml += `<option value="${ip}" ${selected}>${ip}</option>`;
            });
            ipHtml += `<option value="__manual__">Saisie manuelle...</option></select>`;
            document.getElementById('ipFieldContainer').innerHTML = ipHtml;

            document.getElementById('newIP').addEventListener('change', function() {
                if (this.value === '__manual__') renderInputs('', '');
            });
        }

        function syncRadioIP(select) {
            const ipSelect = document.getElementById('newIP');
            if (select.value === '__manual__') {
                renderInputs('', '');
            } else {
                const selectedOption = select.options[select.selectedIndex];
                const ip = selectedOption.getAttribute('data-ip');
                if (ip) ipSelect.value = ip;
            }
        }

        function renderInputs(nameVal, ipVal) {
            document.getElementById('nameFieldContainer').innerHTML = 
                `<input type="text" id="newDeviceName" placeholder="Ex: Switch-RDC" value="${nameVal}">`;
            document.getElementById('ipFieldContainer').innerHTML = 
                `<input type="text" id="newIP" placeholder="Ex: 192.168.1.10" value="${ipVal}">`;
        }

        function renderSelects(type, nameVal, ipVal) {
            const presets = presetsByType[type];
            let nameHtml = `<select id="newDeviceName" onchange="syncIPFromSelect('${type}')">`;
            nameHtml += `<option value="">-- Choisir --</option>`;
            presets.names.forEach((name, index) => {
                const selected = name === nameVal ? 'selected' : '';
                nameHtml += `<option value="${name}" data-index="${index}" ${selected}>${name}</option>`;
            });
            nameHtml += `<option value="__manual__">Saisie manuelle...</option></select>`;
            document.getElementById('nameFieldContainer').innerHTML = nameHtml;

            let ipHtml = `<select id="newIP">`;
            ipHtml += `<option value="">-- Auto --</option>`;
            presets.ips.forEach((ip) => {
                const selected = ip === ipVal ? 'selected' : '';
                ipHtml += `<option value="${ip}" ${selected}>${ip}</option>`;
            });
            ipHtml += `<option value="__manual__">Saisie manuelle...</option></select>`;
            document.getElementById('ipFieldContainer').innerHTML = ipHtml;
            
            document.getElementById('newIP').addEventListener('change', function() {
                if (this.value === '__manual__') renderInputs('', '');
            });
        }

        function syncIPFromSelect(type) {
            const nameSelect = document.getElementById('newDeviceName');
            const ipSelect = document.getElementById('newIP');
            if (nameSelect.value === '__manual__') {
                renderInputs('', '');
            } else {
                const selectedOption = nameSelect.options[nameSelect.selectedIndex];
                const index = selectedOption.getAttribute('data-index');
                if (index !== null && presetsByType[type].ips[index]) {
                    ipSelect.value = presetsByType[type].ips[index];
                }
            }
        }

        function triggerPhotoUpload() { document.getElementById('photoInput').click(); }

        function processPhoto(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        if (selectedEquipmentId) {
                            const eq = equipments.find(e => e.id === selectedEquipmentId);
                            if (eq) { 
                                eq.photo = dataUrl; 
                                markAsUnsaved(); 
                                render(); 
                                showToast("Photo ajout√©e ! üì∑"); 
                            }
                        }
                    }
                }
                reader.readAsDataURL(file);
            }
            input.value = ''; 
        }

        function openPhotoViewer(photoData) {
            document.getElementById('full-photo').src = photoData;
            document.getElementById('photo-modal-overlay').style.display = 'flex';
        }
        function closePhotoViewer() { document.getElementById('photo-modal-overlay').style.display = 'none'; }

        function deleteCurrentPhoto() {
            if (confirm("Supprimer cette photo ?")) {
                if (selectedEquipmentId) {
                    const eq = equipments.find(e => e.id === selectedEquipmentId);
                    if (eq && eq.photo) { 
                        delete eq.photo; 
                        markAsUnsaved(); 
                        render(); 
                        closePhotoViewer(); 
                        showToast("Photo supprim√©e"); 
                    }
                }
            }
        }

        function updateZoomDisplay() {
            const zoomPercent = Math.round(currentZoom * 100);
            document.getElementById('zoomIndicator').textContent = zoomPercent + '%';
        }

        function updateZoom(delta) {
            const newZoom = currentZoom + delta;
            if (newZoom >= 0.1 && newZoom <= 3.0) { 
                currentZoom = newZoom;
                document.getElementById('workspace-container').style.transform = `scale(${currentZoom})`;
                updateZoomDisplay(); 
            }
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('workspace-container').style.transform = `scale(1)`;
            document.getElementById('workspace-wrapper').scrollLeft = 0;
            document.getElementById('workspace-wrapper').scrollTop = 0;
            updateZoomDisplay(); 
        }

        function updateConnectionsOnly() {
            const layer = document.getElementById('connections-layer');
            layer.innerHTML = ''; 
            
            equipments.forEach(eq => {
                if (eq.parent) {
                    const parent = equipments.find(e => e.id === eq.parent);
                    if (parent) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const startX = parent.x + 80;
                        const startY = parent.y + 120;
                        const endX = eq.x + 80;
                        const endY = eq.y;
                        let offsetX = 0;
                        
                        const lineTop = Math.min(startY, endY);
                        const lineBottom = Math.max(startY, endY);
                        const lineLeft = Math.min(startX, endX);
                        const lineRight = Math.max(startX, endX);
                        
                        equipments.forEach(other => {
                            if (other.id === eq.id || other.id === parent.id) return;
                            const eqLeft = other.x - 20;
                            const eqRight = other.x + 180 + 20;
                            const eqTop = other.y - 20;
                            const eqBottom = other.y + 140 + 20;
                            
                            const horizontalOverlap = !(eqRight < lineLeft || eqLeft > lineRight);
                            const verticalOverlap = !(eqBottom < lineTop || eqTop > lineBottom);
                            
                            if (horizontalOverlap && verticalOverlap) {
                                if (startX < endX) { offsetX = Math.min(offsetX, eqLeft - 30); } 
                                else { offsetX = Math.max(offsetX, eqRight + 30); }
                            }
                        });
                        
                        let pathData;
                        const midY = (startY + endY) / 2;
                        
                        if (offsetX !== 0) {
                            pathData = `M ${startX} ${startY} L ${startX} ${midY} L ${offsetX} ${midY} L ${offsetX} ${midY} L ${endX} ${midY} L ${endX} ${endY}`;
                        } else {
                            pathData = `M ${startX} ${startY} L ${startX} ${midY} L ${endX} ${midY} L ${endX} ${endY}`;
                        }
                        
                        path.setAttribute("d", pathData); 
                        path.setAttribute("stroke", "#007AFF"); 
                        path.setAttribute("stroke-width", "2");
                        path.setAttribute("stroke-linejoin", "round");
                        path.setAttribute("stroke-linecap", "round");
                        path.setAttribute("fill", "none");
                        layer.appendChild(path);
                    }
                }

                if (eq.linkedTo && eq.id < eq.linkedTo) {
                    const partner = equipments.find(e => e.id === eq.linkedTo);
                    if (partner) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const d = `M ${eq.x + 80} ${eq.y + 30} L ${partner.x + 80} ${partner.y + 30}`;
                        path.setAttribute("d", d);
                        path.setAttribute("stroke", "black");
                        path.setAttribute("stroke-width", "2");
                        path.setAttribute("stroke-dasharray", "5,5"); 
                        path.setAttribute("fill", "none");
                        layer.appendChild(path);
                    }
                }
            });
        }

        function quickAddChild(parentId, e) {
            e.stopPropagation();
            openAddModal();
            document.getElementById('newParent').value = parentId;
            
            const parentNode = equipments.find(eq => eq.id === parentId);
            if(parentNode) {
                suggestedX = parentNode.x + 50; 
                suggestedY = parentNode.y + 150; 
            }
            showToast("Parent pr√©-s√©lectionn√©");
        }

        function render() {
            document.querySelectorAll('.node').forEach(el => el.remove());
            
            equipments.forEach(eq => {
                const div = document.createElement('div');
                div.className = 'node'; div.id = eq.id;
                div.style.left = eq.x + 'px'; div.style.top = eq.y + 'px';
                if(eq.id === selectedEquipmentId) div.classList.add('selected');

                let photoHtml = '';
                if (eq.photo) {
                    div.classList.add('node-with-photo');
                    photoHtml = `<div class="photo-section">
                                    <img src="${eq.photo}" class="field-photo">
                                    <div class="photo-badge">üì∑</div>
                                 </div>`;
                }

                div.innerHTML = `
                    <div class="quick-delete-btn" onclick="deleteThisEquipment('${eq.id}', event)">‚úï</div>
                    <div class="quick-add-btn" onclick="quickAddChild('${eq.id}', event)">+</div>
                    ${photoHtml}
                    <div class="icon">${getIcon(eq.type)}</div>
                    <div class="device-name">${eq.deviceName}</div>
                    ${eq.ip ? `<div class="ip-addr">${eq.ip}</div>` : ''} <div class="loc">${eq.loc}</div>`;
                
                if (eq.photo) {
                    const photoSec = div.querySelector('.photo-section');
                    if (photoSec) {
                        photoSec.addEventListener('dblclick', (e) => {
                            e.stopPropagation();
                            selectedEquipmentId = eq.id; 
                            openPhotoViewer(eq.photo);
                        });
                    }
                }

                div.addEventListener('mousedown', startDrag);
                div.addEventListener('touchstart', startDrag, {passive: false});
                
                div.addEventListener('click', (e) => { 
                    e.stopPropagation(); deselectAll(); div.classList.add('selected');
                    selectedEquipmentId = eq.id; updateFloatingButtons();
                });

                div.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.photo-section')) return;
                    e.stopPropagation(); 
                    openEditModal(eq.id);
                });

                document.getElementById('workspace-container').appendChild(div);
            });
            updateConnectionsOnly();
        }

        let activeDragId = null; let dragStartX = 0; let dragStartY = 0; let initialObjX = 0; let initialObjY = 0;

        function startDrag(e) {
            // Emp√™cher le drag si on clique sur les boutons rapides
            // Sauf si on est en mode s√©lection, o√π le drag est g√©r√© par la box
            if (isSelectionMode) return;
            
            if (e.target.classList.contains('quick-add-btn') || e.target.classList.contains('quick-delete-btn')) return;

            activeDragId = e.currentTarget.id;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragStartX = clientX; dragStartY = clientY;
            const eq = equipments.find(item => item.id === activeDragId);
            initialObjX = eq.x; initialObjY = eq.y;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, {passive: false});
            document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag);
        }

        function onDrag(e) {
            if (!activeDragId) return;
            e.preventDefault(); 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = (clientX - dragStartX) / currentZoom;
            const deltaY = (clientY - dragStartY) / currentZoom;
            const newX = initialObjX + deltaX;
            const newY = initialObjY + deltaY;
            const eq = equipments.find(item => item.id === activeDragId);
            eq.x = Math.max(0, newX); eq.y = Math.max(0, newY);
            const el = document.getElementById(activeDragId);
            el.style.left = eq.x + 'px'; el.style.top = eq.y + 'px';
            updateConnectionsOnly();
        }

        function endDrag() { 
            activeDragId = null; 
            markAsUnsaved(); 
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }
        
        function deselectAll(e) { 
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected')); 
            selectedEquipmentId = null; updateFloatingButtons();
        }
        
        function deleteThisEquipment(id, event) {
            event.stopPropagation(); 
            
            if (confirm("Supprimer cet √©quipement ?")) {
                const target = equipments.find(e => e.id === id);
                if (target && target.linkedTo) {
                    const partner = equipments.find(e => e.id === target.linkedTo);
                    if (partner) delete partner.linkedTo;
                }

                equipments = equipments.filter(eq => eq.id !== id);
                
                equipments.forEach(e => { 
                    if (e.parent === id) e.parent = null; 
                });
                
                selectedEquipmentId = null;
                markAsUnsaved(); 
                updateFloatingButtons();
                render();
                showToast("‚úÖ √âquipement supprim√©");
            }
        }

        function updateFloatingButtons() {
            const photoBtn = document.getElementById('photo-btn');
            if (selectedEquipmentId) { 
                photoBtn.classList.add('show'); 
            } else { 
                photoBtn.classList.remove('show'); 
            }
        }

        /* MODIFI√â : Retourne l'ID pour le parentage des HP */
        function addSingleNode(type, name, ip, loc, parent, x, y) {
            const newId = 'eq-' + Date.now() + Math.random().toString(36).substr(2, 5);
            equipments.push({
                id: newId,
                type: type,
                deviceName: name,
                ip: ip,
                loc: loc,
                parent: parent,
                x: x, y: y
            });
            return newId;
        }

        function checkInput() { 
            document.getElementById('btnDownload').classList.toggle('disabled', !document.getElementById('siteName').value);
            markAsUnsaved(); 
        }

        function downloadPDF() {
            const name = document.getElementById('siteName').value; deselectAll();
            const oldZoom = currentZoom;
            document.getElementById('workspace-container').style.transform = `scale(1)`;
            html2canvas(document.getElementById('workspace-container'), { scale: 2 }).then(canvas => {
                const pdf = new jspdf.jsPDF({ orientation: 'l', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Synoptique_${name}.pdf`);
                document.getElementById('workspace-container').style.transform = `scale(${oldZoom})`;
            });
        }

        window.onload = render;
    </script>
</body>
</html>
