<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Synoptique Technicien</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --border: #C6C6C8;
            --success: #34C759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            height: 100dvh; width: 100%;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- S√âCURIT√â --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1d1d1f; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10000; color: white; transition: opacity 0.3s;
        }
        .auth-box { background: #2c2c2e; padding: 25px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #1c1c1e; color: white; font-size: 1.2rem; text-align: center; box-sizing: border-box; }

        /* --- HEADER --- */
        .header {
            background-color: var(--card);
            padding-top: env(safe-area-inset-top); 
            padding-bottom: 10px; padding-left: 15px; padding-right: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0;
        }
        .header input { border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-size: 1rem; width: 100%; max-width: 160px; }
        
        .header-actions { display: flex; gap: 8px; }
        
        .header-btn { background: none; border: none; font-size: 1.4rem; padding: 5px; cursor: pointer; }
        .header-btn.primary { color: var(--primary); font-weight: bold; }
        .header-btn.save { color: var(--success); }
        .header-btn.disabled { opacity: 0.3; pointer-events: none; }

        /* --- WORKSPACE & ZOOM --- */
        #workspace-wrapper { 
            flex-grow: 1; 
            position: relative; 
            overflow: auto; 
            -webkit-overflow-scrolling: touch; 
            z-index: 1; 
            background-color: var(--bg);
        }
        
        #workspace-container { 
            position: relative; 
            width: 3000px; 
            height: 3000px; 
            background-image: radial-gradient(#ccc 1px, transparent 1px); 
            background-size: 20px 20px; 
            touch-action: none; 
            transform-origin: 0 0; 
            transition: transform 0.1s ease-out; 
        }
        
        #connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* --- BOITIER EQUIPEMENT --- */
        .node {
            position: absolute; background: var(--card); border: 2px solid #ddd; border-radius: 10px;
            padding: 10px; width: 160px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 2; user-select: none; 
            touch-action: none; 
        }
        .node.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.2); z-index: 10; }
        .node .icon { margin-bottom: 5px; height: 60px; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .node-image { max-width: 90%; max-height: 100%; object-fit: contain; }
        .node .device-name { font-weight: 700; font-size: 0.9rem; text-align: center; margin-top: 5px; color: #1d1d1f; }
        .node .ip-addr { font-size: 0.8rem; color: var(--primary); font-family: monospace; font-weight: 600; margin: 2px 0; }
        .node .loc { font-size: 0.75rem; color: #86868b; text-align: center; font-style: italic; }

        /* Badge Photo sur l'√©quipement */
        .photo-badge {
            position: absolute;
            top: 5px; right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 20px; height: 20px;
            font-size: 12px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none;
        }

        /* --- UI FLOTTANTE (Poubelle & Zoom & Photo) --- */
        .floating-ui {
            position: fixed;
            bottom: 30px;
            display: flex;
            align-items: center;
            z-index: 250;
        }

        /* CACHER BOUTONS MODAL */
        .floating-ui.modal-open { display: none !important; }

        .trash-zone { left: 20px; flex-direction: column-reverse; gap: 15px; }
        .zoom-zone { right: 20px; gap: 10px; flex-direction: column; }

        .fab-btn {
            width: 55px; height: 55px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .fab-btn:active { transform: scale(0.95); }

        /* Style Poubelle */
        #trash-btn { background: var(--danger); color: white; display: none; }
        #trash-btn.show { display: flex; animation: popIn 0.2s; }

        /* Style Bouton Photo */
        #photo-btn { background: var(--primary); color: white; display: none; margin-bottom: 5px;}
        #photo-btn.show { display: flex; animation: popIn 0.2s; }

        /* Style Zoom */
        .zoom-btn { background: white; color: #333; font-weight: bold; font-size: 28px; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- MODALE AJOUT --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 200; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: 40px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* MODAL VISUALISATION PHOTO */
        #photo-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 300;
            flex-direction: column;
        }
        #full-photo { max-width: 95%; max-height: 80vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .photo-controls { margin-top: 20px; display: flex; gap: 20px; }
        .icon-btn { background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);}

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #FAFAFA; }
        .btn-full { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #E5E5EA; color: black; margin-top: 5px;}
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 300; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h3>üîê Acc√®s Technicien</h3>
            <input type="tel" id="pass-field" class="auth-input" placeholder="Code" maxlength="4">
            <button class="btn-full btn-primary" onclick="checkPass()">Valider</button>
        </div>
    </div>

    <input type="file" id="fileLoader" style="display:none" accept=".json" onchange="loadProject(this)">
    
    <input type="file" id="photoInput" style="display:none" accept="image/*" onchange="processPhoto(this)">

    <div class="header">
        <input type="text" id="siteName" placeholder="Nom du Site *" oninput="checkInput()">
        <div class="header-actions">
            <button class="header-btn save" onclick="saveProject()" title="Sauvegarder">üíæ</button>
            <button class="header-btn" onclick="triggerLoad()" title="Ouvrir">üìÇ</button>
            <button class="header-btn disabled" id="btnDownload" onclick="downloadPDF()">‚¨á</button>
            <button class="header-btn primary" onclick="openAddModal()">+</button>
        </div>
    </div>

    <div class="floating-ui trash-zone">
        <button class="fab-btn" id="trash-btn" onclick="deleteSelectedEquipment()">üóëÔ∏è</button>
        <button class="fab-btn" id="photo-btn" onclick="triggerPhotoUpload()">üì∑</button>
    </div>

    <div class="floating-ui zoom-zone">
        <button class="fab-btn zoom-btn" onclick="updateZoom(0.1)">+</button>
        <button class="fab-btn zoom-btn" style="font-size:20px;" onclick="resetZoom()">‚åÇ</button>
        <button class="fab-btn zoom-btn" onclick="updateZoom(-0.1)">-</button>
    </div>

    <div id="workspace-wrapper">
        <div id="workspace-container" onclick="deselectAll(event)">
            <svg id="connections-layer"></svg>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <h3 id="modalTitle">Nouvel √âquipement</h3>
            <div class="form-group">
                <label>Type d'appareil</label>
                <select id="newType">
                    <option value="routeur">Routeur Mikrotik</option>
                    <option value="switch">Switch Hikvision</option>
                    <option value="nvr">NVR Hikvision</option>
                    <option value="bullet">Cam√©ra Bullet</option>
                    <option value="dome">Cam√©ra D√¥me</option>
                    <option value="box">Box / Internet</option>
                    <option value="ecran">√âcran (PC)</option>
                    <option value="radio">Antenne Radio</option>
                    <option value="ampli">Ampli Audio</option>
                    <option value="hp">Haut-Parleur (HP)</option>
                    <option value="pupitre">Pupitre Micro</option>
                </select>
            </div>
            <div class="form-group"><label>Nom / R√©f</label><input type="text" id="newDeviceName" placeholder="Ex: Switch-RDC"></div>
            <div class="form-group"><label>Adresse IP</label><input type="text" id="newIP" placeholder="Ex: 192.168.1.10"></div>
            <div class="form-group"><label>Localisation</label><input type="text" id="newLocation" placeholder="Ex: Baie de brassage"></div>
            <div class="form-group"><label>Connect√© √†</label><select id="newParent"><option value="">-- Racine --</option></select></div>
            <button id="modalActionBtn" class="btn-full btn-primary" onclick="addEquipment()">Ajouter</button>
            <button class="btn-full btn-cancel" onclick="closeAddModal()">Annuler</button>
        </div>
    </div>

    <div id="photo-modal-overlay">
        <img id="full-photo" src="" alt="Photo √©quipement">
        <div class="photo-controls">
            <button class="icon-btn" onclick="closePhotoViewer()" style="background:rgba(255,255,255,0.3)">‚úï</button>
            <button class="icon-btn" onclick="deleteCurrentPhoto()" style="background:rgba(255,59,48,0.6)">üóëÔ∏è</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let selectedEquipmentId = null;
        let currentZoom = 1;
        
        // AJOUT√â POUR √âDITION : Variable pour stocker l'ID en cours d'√©dition
        let editingEquipmentId = null; 

        function checkPass() {
            if(document.getElementById('pass-field').value === "1234") {
                document.getElementById('auth-overlay').style.display = 'none';
            } else { alert("Code incorrect"); }
        }

        let equipments = [
            { id: 'root', type: 'routeur', deviceName: 'Routeur Principal', ip: '192.168.1.1', loc: 'Entr√©e', x: 200, y: 100, parent: null }
        ];

        function getIcon(type) {
            const imageMap = {
                'routeur': 'routeur.jpg',
                'switch': 'com1.jpg',
                'nvr': 'nvr.jpg',
                'bullet': 'cam1.jpg',
                'dome': 'cam2.jpg',
                'box': 'internet.jpg',
                'ecran': 'pc.jpg',
                'radio': 'radio.jpg',
                'ampli': 'ampli.jpg',
                'hp': 'hp.jpg',
                'pupitre': 'pupitre.jpg'
            };
            return `<img src="${imageMap[type] || 'routeur.jpg'}" class="node-image">`;
        }

        // --- SAUVEGARDE ET CHARGEMENT ---
        function saveProject() {
            const name = document.getElementById('siteName').value || "Synoptique_SansNom";
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(equipments));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", name + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Sauvegarde effectu√©e ! üíæ");
        }

        function triggerLoad() {
            document.getElementById('fileLoader').click();
        }

        function loadProject(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if(Array.isArray(loadedData)) {
                        equipments = loadedData;
                        render();
                        let fileName = file.name.replace('.json', '');
                        if(fileName.includes('Synoptique_')) fileName = fileName.replace('Synoptique_', '');
                        if(fileName !== 'SansNom') document.getElementById('siteName').value = fileName;
                        
                        showToast("Projet charg√© avec succ√®s ! üìÇ");
                    } else {
                        alert("Format de fichier invalide.");
                    }
                } catch(err) {
                    alert("Erreur lors de la lecture du fichier.");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        // --- GESTION PHOTOS ---
        function triggerPhotoUpload() {
            document.getElementById('photoInput').click();
        }

        function processPhoto(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        if (selectedEquipmentId) {
                            const eq = equipments.find(e => e.id === selectedEquipmentId);
                            if (eq) {
                                eq.photo = dataUrl;
                                render();
                                showToast("Photo ajout√©e ! üì∑");
                            }
                        }
                    }
                }
                reader.readAsDataURL(file);
            }
            input.value = ''; 
        }

        function openPhotoViewer(photoData) {
            document.getElementById('full-photo').src = photoData;
            document.getElementById('photo-modal-overlay').style.display = 'flex';
        }

        function closePhotoViewer() {
            document.getElementById('photo-modal-overlay').style.display = 'none';
        }

        function deleteCurrentPhoto() {
            if (confirm("Supprimer cette photo ?")) {
                if (selectedEquipmentId) {
                    const eq = equipments.find(e => e.id === selectedEquipmentId);
                    if (eq && eq.photo) {
                        delete eq.photo;
                        render();
                        closePhotoViewer();
                        showToast("Photo supprim√©e");
                    }
                }
            }
        }

        // --- GESTION ZOOM ---
        function updateZoom(delta) {
            const newZoom = currentZoom + delta;
            if (newZoom >= 0.2 && newZoom <= 3.0) { 
                currentZoom = newZoom;
                const container = document.getElementById('workspace-container');
                container.style.transform = `scale(${currentZoom})`;
            }
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('workspace-container').style.transform = `scale(1)`;
            document.getElementById('workspace-wrapper').scrollLeft = 0;
            document.getElementById('workspace-wrapper').scrollTop = 0;
        }

        function updateConnectionsOnly() {
            const layer = document.getElementById('connections-layer');
            layer.innerHTML = ''; 
            
            equipments.forEach(eq => {
                if (eq.parent) {
                    const parent = equipments.find(e => e.id === eq.parent);
                    if (parent) {
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const d = `M ${parent.x + 80} ${parent.y + 100} C ${parent.x + 80} ${(parent.y + 100 + eq.y)/2}, ${eq.x + 80} ${(parent.y + 100 + eq.y)/2}, ${eq.x + 80} ${eq.y}`;
                        path.setAttribute("d", d); 
                        path.setAttribute("stroke", "#007AFF"); 
                        path.setAttribute("stroke-width", "3"); 
                        path.setAttribute("fill", "none");
                        layer.appendChild(path);
                    }
                }
            });
        }

        function render() {
            document.querySelectorAll('.node').forEach(el => el.remove());
            
            equipments.forEach(eq => {
                const div = document.createElement('div');
                div.className = 'node'; 
                div.id = eq.id;
                div.style.left = eq.x + 'px'; 
                div.style.top = eq.y + 'px';
                
                if(eq.id === selectedEquipmentId) div.classList.add('selected');

                let iconContent = getIcon(eq.type);
                let badgeHtml = '';
                
                if (eq.photo) {
                    iconContent = `<img src="${eq.photo}" class="node-image" style="border-radius:4px;">`;
                    badgeHtml = `<div class="photo-badge">üì∑</div>`;
                }

                div.innerHTML = `${badgeHtml}
                                 <div class="icon">${iconContent}</div>
                                 <div class="device-name">${eq.deviceName}</div>
                                 <div class="ip-addr">${eq.ip}</div>
                                 <div class="loc">${eq.loc}</div>`;
                
                div.addEventListener('mousedown', startDrag);
                div.addEventListener('touchstart', startDrag, {passive: false});
                
                div.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    deselectAll(); 
                    div.classList.add('selected');
                    selectedEquipmentId = eq.id;
                    updateFloatingButtons();
                });

                // AJOUT√â POUR √âDITION : Double-clic pour ouvrir en mode √©dition
                div.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    // On emp√™che l'ouverture si on est en train de draguer (drapeau dans onDrag si n√©cessaire)
                    // Mais ici le dblclick est distinct du drag gr√¢ce √† la logique HTML native
                    openEditModal(eq.id);
                });

                document.getElementById('workspace-container').appendChild(div);
            });
            updateConnectionsOnly();
        }

        let activeDragId = null; 
        let dragStartX = 0; 
        let dragStartY = 0;
        let initialObjX = 0;
        let initialObjY = 0;

        function startDrag(e) {
            activeDragId = e.currentTarget.id;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragStartX = clientX; dragStartY = clientY;
            const eq = equipments.find(item => item.id === activeDragId);
            initialObjX = eq.x; initialObjY = eq.y;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, {passive: false});
            document.addEventListener('mouseup', endDrag); 
            document.addEventListener('touchend', endDrag);
        }

        function onDrag(e) {
            if (!activeDragId) return;
            e.preventDefault(); 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = (clientX - dragStartX) / currentZoom;
            const deltaY = (clientY - dragStartY) / currentZoom;
            const newX = initialObjX + deltaX;
            const newY = initialObjY + deltaY;
            const eq = equipments.find(item => item.id === activeDragId);
            eq.x = Math.max(0, newX); eq.y = Math.max(0, newY);
            const el = document.getElementById(activeDragId);
            el.style.left = eq.x + 'px'; el.style.top = eq.y + 'px';
            updateConnectionsOnly();
        }

        function endDrag() { 
            activeDragId = null; 
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }
        
        function deselectAll(e) { 
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected')); 
            selectedEquipmentId = null;
            updateFloatingButtons();
        }
        
        function deleteSelectedEquipment() {
            if (!selectedEquipmentId) return;
            
            if(confirm("Supprimer cet √©quipement ?")) {
                equipments = equipments.filter(eq => eq.id !== selectedEquipmentId);
                // Si des enfants √©taient connect√©s √† ce parent, on les d√©tache
                equipments.forEach(e => { if(e.parent === selectedEquipmentId) e.parent = null; });
                selectedEquipmentId = null;
                updateFloatingButtons();
                render();
            }
        }

        // Gestion de l'affichage des boutons flottants
        function updateFloatingButtons() {
            const trashBtn = document.getElementById('trash-btn');
            const photoBtn = document.getElementById('photo-btn');
            
            if (selectedEquipmentId) {
                trashBtn.classList.add('show');
                photoBtn.classList.add('show');
            } else {
                trashBtn.classList.remove('show');
                photoBtn.classList.remove('show');
            }
        }

        function openAddModal() {
            document.querySelectorAll('.floating-ui').forEach(el => el.classList.add('modal-open'));

            const sel = document.getElementById('newParent');
            sel.innerHTML = '<option value="">-- Racine --</option>';
            equipments.forEach(eq => sel.innerHTML += `<option value="${eq.id}">${eq.deviceName}</option>`);
            
            // AJOUT√â POUR √âDITION : Mode AJOUT par d√©faut
            editingEquipmentId = null;
            document.getElementById('modalTitle').innerText = "Nouvel √âquipement";
            document.getElementById('modalActionBtn').innerText = "Ajouter";
            document.getElementById('newType').value = 'switch';
            document.getElementById('newDeviceName').value = '';
            document.getElementById('newIP').value = '';
            document.getElementById('newLocation').value = '';
            document.getElementById('newParent').value = '';

            document.getElementById('addModal').style.display = 'flex';
        }

        // AJOUT√â POUR √âDITION : Fonction pour ouvrir le modal en mode √©dition
        function openEditModal(id) {
            const eq = equipments.find(e => e.id === id);
            if (!eq) return;

            document.querySelectorAll('.floating-ui').forEach(el => el.classList.add('modal-open'));

            // Pr√©parer la liste des parents (pour √©viter de se s√©lectionner soi-m√™me comme parent)
            const sel = document.getElementById('newParent');
            sel.innerHTML = '<option value="">-- Racine --</option>';
            equipments.forEach(e => {
                if (e.id !== id) { // On ne peut pas √™tre son propre parent
                    sel.innerHTML += `<option value="${e.id}">${e.deviceName}</option>`;
                }
            });

            // Remplir les champs avec les donn√©es existantes
            editingEquipmentId = id;
            document.getElementById('modalTitle').innerText = "Modifier l'√âquipement";
            document.getElementById('modalActionBtn').innerText = "Modifier";
            
            document.getElementById('newType').value = eq.type;
            document.getElementById('newDeviceName').value = eq.deviceName;
            document.getElementById('newIP').value = eq.ip;
            document.getElementById('newLocation').value = eq.loc;
            document.getElementById('newParent').value = eq.parent || '';

            document.getElementById('addModal').style.display = 'flex';
        }

        function closeAddModal() { 
            document.getElementById('addModal').style.display = 'none'; 
            document.querySelectorAll('.floating-ui').forEach(el => el.classList.remove('modal-open'));
            
            // AJOUT√â POUR √âDITION : Reset des variables d'√©dition √† la fermeture
            editingEquipmentId = null;
            document.getElementById('modalTitle').innerText = "Nouvel √âquipement";
            document.getElementById('modalActionBtn').innerText = "Ajouter";
        }

        // MODIFI√â POUR √âDITION : Gestion du mode Ajout ou √âdition
        function addEquipment() {
            const type = document.getElementById('newType').value;
            const deviceName = document.getElementById('newDeviceName').value || "Appareil";
            const ip = document.getElementById('newIP').value || "0.0.0.0";
            const loc = document.getElementById('newLocation').value || "Lieu";
            const parent = document.getElementById('newParent').value || null;

            if (editingEquipmentId) {
                // MODE √âDITION : Mise √† jour de l'existant
                const eq = equipments.find(e => e.id === editingEquipmentId);
                if (eq) {
                    eq.type = type;
                    eq.deviceName = deviceName;
                    eq.ip = ip;
                    eq.loc = loc;
                    eq.parent = parent;
                    showToast("√âquipement modifi√© !");
                }
            } else {
                // MODE AJOUT : Cr√©ation d'un nouveau
                const newEq = {
                    id: 'eq-' + Date.now(),
                    type: type,
                    deviceName: deviceName,
                    ip: ip,
                    loc: loc,
                    parent: parent,
                    x: (document.getElementById('workspace-wrapper').scrollLeft + 100) / currentZoom, 
                    y: (document.getElementById('workspace-wrapper').scrollTop + 200) / currentZoom
                };
                equipments.push(newEq);
                showToast("√âquipement ajout√© !");
            }

            // AJOUT√â POUR √âDITION : D√©s√©lectionner apr√®s modification
            selectedEquipmentId = null;
            updateFloatingButtons();

            render(); 
            closeAddModal();
        }

        function checkInput() { document.getElementById('btnDownload').classList.toggle('disabled', !document.getElementById('siteName').value); }

        function downloadPDF() {
            const name = document.getElementById('siteName').value; deselectAll();
            const oldZoom = currentZoom;
            document.getElementById('workspace-container').style.transform = `scale(1)`;
            
            html2canvas(document.getElementById('workspace-container'), { scale: 2 }).then(canvas => {
                const pdf = new jspdf.jsPDF({ orientation: 'l', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Synoptique_${name}.pdf`);
                document.getElementById('workspace-container').style.transform = `scale(${oldZoom})`;
            });
        }

        window.onload = render;
    </script>
</body>
</html>
