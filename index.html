<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Synoptique Technicien</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --border: #C6C6C8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            height: 100dvh; width: 100%;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1d1d1f; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 10000; color: white; transition: opacity 0.3s;
        }

        .auth-box { background: #2c2c2e; padding: 25px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #1c1c1e; color: white; font-size: 1.2rem; text-align: center; box-sizing: border-box; }

        .header {
            background-color: var(--card);
            padding-top: env(safe-area-inset-top); 
            padding-bottom: 10px; padding-left: 15px; padding-right: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0;
        }

        .header input { border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-size: 1rem; width: 100%; max-width: 180px; }
        .header-btn { background: none; border: none; font-size: 1.5rem; padding: 5px 10px; cursor: pointer; }
        .header-btn.primary { color: var(--primary); font-weight: bold; }
        .header-btn.disabled { opacity: 0.3; pointer-events: none; }

        #workspace-wrapper { flex-grow: 1; position: relative; overflow: auto; -webkit-overflow-scrolling: touch; z-index: 1; }
        #workspace-container { position: relative; min-height: 100%; min-width: 100%; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px; touch-action: none; width: 2500px; height: 2500px; }
        #connections-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .node {
            position: absolute; background: var(--card); border: 2px solid #ddd; border-radius: 10px;
            padding: 10px; width: 160px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 2; user-select: none; touch-action: none;
        }

        .node.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.2); z-index: 10; }
        .node .icon { margin-bottom: 5px; height: 60px; width: 100%; display: flex; justify-content: center; align-items: center; }
        .node-image { max-width: 90%; max-height: 100%; object-fit: contain; }
        .node .device-name { font-weight: 700; font-size: 0.9rem; text-align: center; margin-top: 5px; color: #1d1d1f; }
        .node .ip-addr { font-size: 0.8rem; color: var(--primary); font-family: monospace; font-weight: 600; margin: 2px 0; }
        .node .loc { font-size: 0.75rem; color: #86868b; text-align: center; font-style: italic; }

        .delete-btn { position: absolute; top: -12px; right: -12px; background: var(--danger); color: white; border-radius: 50%; width: 32px; height: 32px; text-align: center; line-height: 32px; font-size: 18px; display: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; }
        .node.selected .delete-btn { display: block; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 200; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: 40px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #FAFAFA; }
        .btn-full { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #E5E5EA; color: black; margin-top: 5px;}
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 300; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h3>üîê Acc√®s Technicien</h3>
            <input type="tel" id="pass-field" class="auth-input" placeholder="Code" maxlength="4">
            <button class="btn-full btn-primary" onclick="checkPass()">Valider</button>
        </div>
    </div>

    <div class="header">
        <input type="text" id="siteName" placeholder="Nom du Site *" oninput="checkInput()">
        <div style="display:flex; gap:10px;">
            <button class="header-btn disabled" id="btnDownload" onclick="downloadPDF()">‚¨á</button>
            <button class="header-btn primary" onclick="openAddModal()">+</button>
        </div>
    </div>

    <div id="workspace-wrapper">
        <div id="workspace-container" onclick="deselectAll(event)">
            <svg id="connections-layer"></svg>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <h3>Nouvel √âquipement</h3>
            <div class="form-group">
                <label>Type d'appareil</label>
                <select id="newType">
                    <option value="routeur">Routeur Mikrotik</option>
                    <option value="switch">Switch Hikvision</option>
                    <option value="nvr">NVR Hikvision</option>
                    <option value="bullet">Cam√©ra Bullet (Cam1)</option>
                    <option value="dome">Cam√©ra D√¥me (Cam2)</option>
                    <option value="box">Box / Internet</option>
                    <option value="ecran">√âcran (PC)</option>
                    <option value="radio">Antenne Radio</option>
                    <option value="ampli">Ampli Audio</option>
                    <option value="hp">Haut-Parleur (HP)</option>
                    <option value="pupitre">Pupitre Micro</option>
                </select>
            </div>
            <div class="form-group"><label>Nom / R√©f</label><input type="text" id="newDeviceName" placeholder="Ex: Switch-RDC"></div>
            <div class="form-group"><label>Adresse IP</label><input type="text" id="newIP" placeholder="Ex: 192.168.1.10"></div>
            <div class="form-group"><label>Localisation</label><input type="text" id="newLocation" placeholder="Ex: Baie de brassage"></div>
            <div class="form-group"><label>Connect√© √†</label><select id="newParent"><option value="">-- Racine --</option></select></div>
            <button class="btn-full btn-primary" onclick="addEquipment()">Ajouter</button>
            <button class="btn-full btn-cancel" onclick="closeAddModal()">Annuler</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        function checkPass() {
            if(document.getElementById('pass-field').value === "1234") {
                document.getElementById('auth-overlay').style.display = 'none';
            } else { alert("Code incorrect"); }
        }

        let equipments = [
            { id: 'root', type: 'routeur', deviceName: 'Routeur Principal', ip: '192.168.1.1', loc: 'Entr√©e', x: 200, y: 100, parent: null }
        ];

        function getIcon(type) {
            const imageMap = {
                'routeur': 'routeur.jpg',
                'switch': 'com1.jpg',
                'nvr': 'nvr.jpg',
                'bullet': 'cam1.jpg',   // Corresponds √† ton fichier cam1.jpg
                'dome': 'cam2.jpg',     // Corresponds √† ton fichier cam2.jpg
                'box': 'internet.jpg',  // Corresponds √† ton fichier internet.jpg
                'ecran': 'pc.jpg',      // Corresponds √† ton fichier pc.jpg
                'radio': 'radio.jpg',
                'ampli': 'ampli.jpg',
                'hp': 'hp.jpg',
                'pupitre': 'pupitre.jpg'
            };
            return `<img src="${imageMap[type] || 'routeur.jpg'}" class="node-image">`;
        }

        function render() {
            document.querySelectorAll('.node').forEach(el => el.remove());
            document.getElementById('connections-layer').innerHTML = '';
            equipments.forEach(eq => {
                const div = document.createElement('div');
                div.className = 'node'; div.id = eq.id;
                div.style.left = eq.x + 'px'; div.style.top = eq.y + 'px';
                div.innerHTML = `<div class="delete-btn" onpointerdown="deleteNode('${eq.id}', event)">‚úï</div>
                                 <div class="icon">${getIcon(eq.type)}</div>
                                 <div class="device-name">${eq.deviceName}</div>
                                 <div class="ip-addr">${eq.ip}</div>
                                 <div class="loc">${eq.loc}</div>`;
                div.addEventListener('mousedown', startDrag);
                div.addEventListener('touchstart', startDrag, {passive: false});
                div.addEventListener('click', (e) => { e.stopPropagation(); deselectAll(); div.classList.add('selected'); });
                document.getElementById('workspace-container').appendChild(div);
                if (eq.parent) drawConnection(eq);
            });
        }

        function drawConnection(eq) {
            const parent = equipments.find(e => e.id === eq.parent);
            if (!parent) return;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const d = `M ${parent.x + 80} ${parent.y + 100} C ${parent.x + 80} ${(parent.y + 100 + eq.y)/2}, ${eq.x + 80} ${(parent.y + 100 + eq.y)/2}, ${eq.x + 80} ${eq.y}`;
            path.setAttribute("d", d); path.setAttribute("stroke", "#007AFF"); path.setAttribute("stroke-width", "3"); path.setAttribute("fill", "none");
            document.getElementById('connections-layer').appendChild(path);
        }

        let activeDragId = null; let dragOffsetX = 0; let dragOffsetY = 0;
        function startDrag(e) {
            if(e.target.className === 'delete-btn') return;
            e.preventDefault();
            activeDragId = e.currentTarget.id;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffsetX = clientX - rect.left; dragOffsetY = clientY - rect.top;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, {passive: false});
            document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag);
        }

        function onDrag(e) {
            if (!activeDragId) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const wrapper = document.getElementById('workspace-wrapper').getBoundingClientRect();
            let newX = clientX - wrapper.left + document.getElementById('workspace-wrapper').scrollLeft - dragOffsetX;
            let newY = clientY - wrapper.top + document.getElementById('workspace-wrapper').scrollTop - dragOffsetY;
            const eq = equipments.find(item => item.id === activeDragId);
            eq.x = Math.max(0, newX); eq.y = Math.max(0, newY);
            const el = document.getElementById(activeDragId);
            el.style.left = eq.x + 'px'; el.style.top = eq.y + 'px';
            render(); // Redessine les lignes
        }

        function endDrag() { activeDragId = null; }
        function deselectAll() { document.querySelectorAll('.node').forEach(n => n.classList.remove('selected')); }
        function deleteNode(id, e) { e.stopPropagation(); if(confirm("Supprimer ?")) { equipments = equipments.filter(eq => eq.id !== id); render(); } }

        function openAddModal() {
            const sel = document.getElementById('newParent');
            sel.innerHTML = '<option value="">-- Racine --</option>';
            equipments.forEach(eq => sel.innerHTML += `<option value="${eq.id}">${eq.deviceName}</option>`);
            document.getElementById('addModal').style.display = 'flex';
        }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

        function addEquipment() {
            const newEq = {
                id: 'eq-' + Date.now(),
                type: document.getElementById('newType').value,
                deviceName: document.getElementById('newDeviceName').value || "Appareil",
                ip: document.getElementById('newIP').value || "0.0.0.0",
                loc: document.getElementById('newLocation').value || "Lieu",
                parent: document.getElementById('newParent').value || null,
                x: 200, y: document.getElementById('workspace-wrapper').scrollTop + 200
            };
            equipments.push(newEq); render(); closeAddModal();
        }

        function checkInput() { document.getElementById('btnDownload').classList.toggle('disabled', !document.getElementById('siteName').value); }

        function downloadPDF() {
            const name = document.getElementById('siteName').value; deselectAll();
            html2canvas(document.getElementById('workspace-container'), { scale: 2 }).then(canvas => {
                const pdf = new jspdf.jsPDF({ orientation: 'l', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Synoptique_${name}.pdf`);
            });
        }

        window.onload = render;
    </script>
</body>
</html>
